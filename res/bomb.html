<!DOCTYPE HTML>
<style>body{ margin: 0; padding: 0 }
img {
  -ms-interpolation-mode: nearest-neighbor;
  image-rendering: -webkit-optimize-contrast;
  image-rendering: -webkit-crisp-edges;
  image-rendering: -moz-crisp-edges;
  image-rendering: -o-crisp-edges;
  image-rendering: pixelated;
}
</style>
<!-- these methods are called by game.html -->
<script>
  var scale = window.location.search.substring(1);
  if(scale)
    scale = parseInt(scale);
  else
    scale = 2;
  var size = 16 * scale;
  var half = size / 2;
  var height = size * 8;
  var width = size * 10;
  var pid;
  function head(seed) { /* play(seed) is broadcasted to N */
    clear();
    this.seed = seed;
    pid = setInterval(tick, 16);
    for(var i = 0; i < 11; i++) {
      for(var j = 0; j < 9; j++) {
        if(i % 2 && j % 2)
          current = add_sprite('floor_center', size * i, size * j, size, size);
      }
    }
    spawn();
  }
  function sent(user, data) { /* send(data) is broadcasted to N-1 */
    var split = data.split('+');
  }
  function pause(hold) {
    if(hold)
      clearInterval(pid);
    else
      pid = setInterval(tick, 16);
  }
  function tail() { /* over(data) is broadcasted to N */
    clearInterval(pid);
    reset();
  }
</script>
<!-- arrow keys for desktop -->
<script>
  var left = false;
  var right = false;
  var up = false;
  var down = false;
  var recent = 0;
  function keydown(event) {
    action(current, event.keyCode, current.fuse.speed);
  }
  function keyup(event) {
    action(current, event.keyCode, 0);
  }
  function action(sprite, key, speed) {
    if(speed > 0 && ((key === 37 && left) || (key === 39 && right) || (key === 40 && down) || (key === 38 && up))) {
      return;
    }
    if(key === 37) {
      if(speed > 0) sprite.fuse.last = 'left';
      if(speed == 0) left = false; else left = true;
      if(speed == 0 && right) { sprite.fuse.dx = sprite.fuse.speed; recent = 39; } else { sprite.fuse.dx = -speed; }
      if(speed > 0) recent = 37;
    }
    if(key === 39) {
      if(speed > 0) sprite.fuse.last = 'right';
      if(speed == 0) right = false; else right = true;
      if(speed == 0 && left) { sprite.fuse.dx = -sprite.fuse.speed; recent = 37; } else { sprite.fuse.dx = speed; }
      if(speed > 0) recent = 39;
    }
    if(key === 40) {
      if(speed > 0) sprite.fuse.last = 'down';
      if(speed == 0) down = false; else down = true;
      if(speed == 0 && up) { sprite.fuse.dy = -sprite.fuse.speed; recent = 38; } else { sprite.fuse.dy = speed; }
      if(speed > 0) recent = 40;
    }
    if(key === 38) {
      if(speed > 0) sprite.fuse.last = 'up';
      if(speed == 0) up = false; else up = true;
      if(speed == 0 && down) { sprite.fuse.dy = sprite.fuse.speed; recent = 40; } else { sprite.fuse.dy = -speed; }
      if(speed > 0) recent = 38;
    }
    if(speed == 0 && !left && !right && !up && !down) {
      recent = 0;
    }
  }
  var pop = new Audio('mp3/pop.mp3');
  var snap = new Audio('mp3/snap.mp3');
</script>
<!-- the game logic -->
<script>
  function reset() {
    element('bomb').innerHTML = '';
    sprites = [];
    next = null;
    score = 0;
    drops = 0;
  }
  function element(name) {
    return document.getElementById(name);
  }
  var seed = 1;
  var current;
  var grid = [];
  var sprites = [];
  var remove = [];
  function random() {
    var x = Math.sin(seed++) * 10000;
    return x - Math.floor(x);
  }
  function limit(min, max) {
    return Math.floor(random() * (max - min + 1)) + min;
  }
  function clear() {
    grid = [];
    for(var i = 0; i < 11; i++)
      grid[i] = [];
  }
  function tick() {
    var landed = [];
    for(var i = 0; i < sprites.length; i++) {
      var sprite = sprites[i];
      if(sprite && sprite.fuse.type == 'player') {
        var x = parseInt(sprite.style.left, 10);
        var y = parseInt(sprite.style.top, 10);
        var dx = x + sprite.fuse.dx;
        var dy = y + sprite.fuse.dy;
        var border = false;
        if(dx < 0) { dx = 0; border = true; }
        if(dy < 0) { dy = 0; border = true; }
        if(dx > width) { dx = width; border = true; }
        if(dy > height) { dy = height; border = true; }
        var col = Math.round(x / size);
        var row = Math.round(y / size);
        sprite.fuse.col = col;
        sprite.fuse.row = row;
        grid[col][row] = sprite;
        var _mx = x % size;
        var _my = y % size;
        var mx = dx % size;
        var my = dy % size;
        var sx = 0;
        var sy = 0;
        var _col = col % 2;
        var _row = row % 2;
        var clear = false;
        var limit = half + current.fuse.dx;
        if(mx != 0 && _my == 0 && (up || down)) {
          if(_col == 1) {
            if(mx >= limit) sx -= sprite.fuse.speed;
            else if(mx < limit) sx += sprite.fuse.speed;
          }
          else if(mx < limit) sx -= sprite.fuse.speed;
          else if(mx >= limit) sx += sprite.fuse.speed;
        }
        limit = half + current.fuse.dy;
        if(_mx == 0 && my != 0 && (left || right)) {
          if(_row == 1) {
            if(my >= limit) sy -= sprite.fuse.speed;
            else if(my < limit) sy += sprite.fuse.speed;
          }
          else if(my < limit) sy -= sprite.fuse.speed;
          else if(my >= limit) sy += sprite.fuse.speed;
        }
        if(sx != 0 || sy != 0) {
          dx = x;
          dy = y;
        }
        var stop = false;
        if(sx != 0 && sy != 0) {
          var move = (_mx == 0 || _my == 0);
          if(move) {
            if(sx != 0 && _col == 1) sy = 0;
            else if(sy != 0 && _row == 1) sx = 0;
            else
              stop = true;
          }
          else
            stop = true;
        }
        if(!stop) {
          var move = (_mx == 0 || _my == 0);
          if(dx >= 0 && dx <= width && move)
            if(sx != 0 && !border) {
              var pos = x + sx;
              var ran = col * size;
              if(pos > ran - sprite.fuse.speed && pos < ran + sprite.fuse.speed) {
                pos = ran;
              }
              sprite.style.left = pos + 'px';
              animate(sprite, sx, 0);
            }
            else if(_row == 0) {
              sprite.style.left = dx + 'px';
              animate(sprite, sprite.fuse.dx, 0);
            }
          if(dy >= 0 && dy <= height && move)
            if(sy != 0 && !border) {
              var pos = y + sy;
              var ran = row * size;
              if(pos > ran - sprite.fuse.speed && pos < ran + sprite.fuse.speed) {
                pos = ran;
              }
              sprite.style.top = pos + 'px';
              animate(sprite, 0, sy);
            }
            else if(_col == 0) {
              sprite.style.top = dy + 'px';
              animate(sprite, 0, sprite.fuse.dy);
            }
        }
      }
    }
  }
  function animate(sprite, dx, dy) {
    var head = sprite.fuse.last;
    if(dx > 0) head = 'right';
    if(dx < 0) head = 'left';
    if(dy > 0) head = 'down';
    if(dy < 0) head = 'up';
    if(dx != 0 || dy != 0) {
      if(sprite.fuse.counter > 6) {
        sprite.fuse.count++;
        if(sprite.fuse.count > 3)
          sprite.fuse.count = 0;
        sprite.fuse.counter = 0;
      }
      sprite.fuse.counter++;
      sprite.fuse.img.src = 'gif/' + sprite.fuse.color + '_' + head + '_' + sprite.fuse.count + '.gif';
    }
    else {
      if(recent == 0)
        sprite.fuse.count = 3;
      sprite.fuse.img.src = 'gif/' + sprite.fuse.color + '_' + head + '_' + sprite.fuse.count + '.gif';
    }
  }
  function contains(a, obj) {
    var i = a.length;
    while(i--) {
      if(a[i] === obj) {
        return true;
      }
    }
    return false;
  }
  var max = 3;
  var min = 0;
  function spawn() {
    current = add_sprite('white', 0, 0, size, size * 2);
  }
  function add_sprite(color, x, y, width, height) {
    var sprite = document.createElement('div');
    var img = document.createElement('img');
    img.style.width = width + 'px';
    img.style.height = height + 'px';
    img.style.position = 'relative';
    sprite.appendChild(img);
    sprite.style.position = 'absolute';
    sprite.style.left = x + 'px';
    sprite.style.top = y + 'px';
    sprite.style.width = width + 'px';
    sprite.style.height = height + 'px';
    sprite.fuse = {};
    sprite.fuse.img = img;
    sprite.fuse.dx = 0;
    sprite.fuse.dy = 0;
    sprite.fuse.color = color;
    if(color == 'white') {
      sprite.fuse.type = 'player';
      sprite.fuse.last = 'down';
      sprite.fuse.count = 3;
      sprite.fuse.counter = 0;
      sprite.fuse.speed = scale;
      img.src = 'gif/' + sprite.fuse.color + '_' + sprite.fuse.last + '_' + sprite.fuse.count + '.gif';
      img.style.bottom = size + 'px';
    }
    else {
      img.src = 'gif/' + color + '.gif';
    }
    sprite.fuse.index = sprites.push(sprite) - 1;
    element('bomb').appendChild(sprite);
    return sprite;
  }
</script>

<div id="bomb" style="background-color: black;"></div>

<script>
  var bomb = element('bomb');
  bomb.style.width = size * 11 + 'px';
  bomb.style.height = size * 9 + 'px';
  document.addEventListener('keydown', keydown);
  document.addEventListener('keyup', keyup);
  var url = window.location.href.split('/');
  if(url[url.length - 1].split('?')[0] === 'bomb.html')
    head(232423);
</script>