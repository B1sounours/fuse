[[	package gen;

import fuse.Router;
import se.rupy.http.*;
import java.util.*;
import java.net.*;
import java.io.*;

public class play extends Service {
	String red = "#ff3300";
	String orange = "#ff9900";
	String blue = "#6699ff";
	String green = "#00cc33";
	
	public String path() { return "/play.html"; }
	public void filter(Event event) throws Event, Exception {
		event.query().parse();
		String host = event.query().string("host", "fuse.rupy.se");
		String game = event.query().string("game", "cube");
		String path = event.query().string("path", game + ".html");
		Output out = event.output(); ]]

<!DOCTYPE HTML>
<html>
<head>
<meta name="viewport" content="width=300, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<style>
  a:link, a:hover, a:active, a:visited { color: [[ blue ]]; }
  img { display: block; }
  div { font-family: monospace; }
  input { font-family: monospace; }
  table { margin: 5px; }
  #fail1 { color: [[ red ]]; }
  #fail2 { color: [[ red ]]; }
  textarea {
    font-family: monospace;
    -webkit-box-sizing: border-box;
    -moz-box-sizing: border-box;
    box-sizing: border-box;
    resize: none;
    width: 100%;
  }
  select {
    font-family: monospace;
    -webkit-box-sizing: border-box;
    -moz-box-sizing: border-box;
    box-sizing: border-box;
    width: 100%;
  }
  #show {
    position: fixed;
    bottom: 5px;
    left: 5px;
  }
</style>
<script src="md5.js"></script>
<!-- fuse network code -->
<script>
  var host = '[[ host ]]';
  var game = '[[ game ]]';
  var show = true;
  var size = 0;
  var salt;
  function pull(salt) {
    this.salt = salt;
    http('pull', null);
  }
  function push(data) {
    var data = http('push', data);
    if(data) {
      var split = data.split('|');
      if(split[1] == 'fail')
        show_fail(split[2]);
      return split;
    }
  }
  function http(path, data) {
    hide_fail();
    var async = false;
    var state = (path == 'pull' ? 3 : 4);
    var xhr = new XMLHttpRequest();
    var ie = false;
    var url = 'http://' + host + '/' + path + '?';
    if(state == 3) {
      async = true;
      url += 'salt=' + salt;
      try { xhr = new XDomainRequest(); url += '&ie'; ie = true; } catch(e) {}
    }
    else {
      var type = data.substring(0, 4);
      if(type == 'chat' || type == 'send')
        async = true;
      if(salt)
        data = type + '|' + salt + data.substring(4, data.length);
      url += 'data=' + encodeURIComponent(data);
    }
    url += "&time=" + new Date().getTime();
    try {
      xhr.open('GET', url, async); // sync is deprecated really? genious!
    }
    catch(e) {
      console.log(url);
      return e;
    }
    if(!ie) xhr.setRequestHeader('Accept', 'text/event-stream');
    if(state == 3) {
      if(ie)
        xhr.onprogress = function() {
          var body = xhr.responseText.substring(size, xhr.responseText.length);
          chop(body, '\n'); // last \n instead
          size = xhr.responseText.length;
        };
      else
        xhr.onreadystatechange = function() {
          if(xhr.readyState == 3) {
            var body = xhr.responseText.substring(size, xhr.responseText.length);
            chop(body, '\n\n'); // last \n\n instead
            size = xhr.responseText.length;
          }
        };
    }
    xhr.send();
    if(state == 4) {
      if(show)
        element('push').innerHTML += xhr.responseText + '\n';
      if(!async)
        return xhr.responseText;
    }
  }
  function chop(body, delimiter) {
    var part = body.split(delimiter);
    for(var i = 0; i < part.length; i++) {
      var trim = part[i].trim();
      if(trim.length > 0)
        if(trim.indexOf('data: ') == 0)
          read(trim.substring(6, trim.length));
        else
          read(trim);
    }
  }
  function element(name) {
    return document.getElementById(name);
  }
</script>
<!-- fuse message handling -->
<script>
  var red = '[[ red ]]';
  var orange = '[[ orange ]]';
  var blue = '[[ blue ]]';
  var green = '[[ green ]]';
  var beep = new Audio('mp3/beep.mp3');
  var select = new Audio('mp3/select.mp3');
  var send_game = true;
  var game_play = false;
  function read(data) {
    //try { console.log(data) } catch(e) {}
    if(show)
      element('pull').innerHTML += data + '\n';
    if(send_game) {
      setTimeout(function() { push('game|' + game); list() }, 1000); // Give IE time to handle 2000kb payload.
      send_game = false;
    }
    var split = data.split('|');
    if(split.length > 0) {
      if(split[0] == 'chat') {
        /* var color = '#000000';
        if(split[1] == 'root') color = red;
        if(split[1] == 'stem') color = blue;
        if(split[1] == 'leaf') color = green; */
        element('chat').value = '[' + split[1] + '] ' + split[2] + ': ' + split[3] + '\n' + element('chat').value;
        select.play();
      }
      if(split[0] == 'lock') {
        update_select('join', split[1], red);
      }
      if(split[0] == 'open') {
        update_select('join', split[1], orange);
      }
      if(split[0] == 'here') {
        add_select('ally', split[2], blue);
        beep.play();
      }
      if(split[0] == 'ally') {
        update_select('ally', split[1], green);
      }
      if(split[0] == 'gone') {
        remove_select('ally', split[2]);
        stop_game();
      }
      if(split[0] == 'room') {
        add_select('join', split[1].split('+')[0], orange);
      }
      if(split[0] == 'drop') {
        remove_select('join', split[1]);
      }
      if(split[0] == 'stop' || split[0] == 'exit') {
        remove_select('ally', split[1]);
        remove_select('join', split[1]);
        if(split[0] == 'stop') {
          element('chat').value = split[1] + ': quit\n' + element('chat').value;
          stop_game();
        }
      }
      if(split[0] == 'play') {
        display('room', 'none');
        display('play', 'block');
        element('talk').style.position = 'absolute';
        element('talk').style.left = '0px';
        element('talk').style.top = '350px';
        head(split[1]);
        game_play = true;
      }
      if(split[0] == 'send') {
        sent(split[1], split[2]);
      }
      if(split[0] == 'over') {
        element('chat').value = split[1] + ': ' + split[2] + '\n' + element('chat').value;
        stop_game();
      }
      if(split[0] == 'away') {
        update_select('ally', split[1], orange);
        element('chat').value = split[1] + ': away\n' + element('chat').value;
      }
      if(split[0] == 'back') {
        update_select('ally', split[1], blue);
        element('chat').value = split[1] + ': back\n' + element('chat').value;
      }
      if(split[0] == 'hold') {
        if(game_play)
      	  pause(true);
      }
      if(split[0] == 'free') {
        if(game_play)
          pause(false);
      }
      if(split[0] == 'poll') {
        if(confirm('Accept challenge from ' + split[1] + '?\n' + (split.length > 2 ? split[2] : ''))) {
          push('poll|' + split[1] + '|true');
        } else {
          push('poll|' + split[1] + '|false');
        }
      }
      if(split[0] == 'warn') {
        alert(split[2]);
        if(split[1] == 'boot') {
          location.reload();
        }
      }
    }
  }
  function stop_game() {
    display('room', 'block');
    display('play', 'none');
    element('talk').style.position = 'static';
    tail();
    game_play = false;
  }
  function remove_select(type, name) {
    var select = element(type);
    var id = -1;
    for(var i = 0; i < select.options.length; i++) {
      if(select.options[i].text == name) {
        id = i;
        break;
      }
    }
    if(id > -1)
      select.remove(id);
  }
  function add_select(type, name, color) {
    var select = element(type);
    for(var i = 0; i < select.options.length; i++) {
      if(select.options[i].text == name) {
        return;
      }
    }
    var option = document.createElement('option');
    option.style.color = color;
    option.text = name;
    select.options.add(option, select.options[0]);
  }
  function update_select(type, name, color) {
    var select = element(type);
    for(var i = 0; i < select.options.length; i++) {
      if(select.options[i].text == name) {
        select.options[i].style.color = color;
        return;
      }
    }
  }
  function clear_join() {
    var select = element('join');
    var length = select.options.length;
    for(i = 0; i < length; i++) {
      select.options[i] = null;
    }
  }
  function hide_fail(text) {
    element('fail1').innerHTML = '';
    element('fail2').innerHTML = '';
  }
  function show_fail(text) {
    element('fail1').innerHTML = text;
    element('fail2').innerHTML = text;
  }
</script>
<!-- fuse view handling -->
<script>
  var name;
  function user() {
    name = id('name');
    if(name.length < 3) {
      show_fail('name too short');
      return;
    }
    var pass = id('pass');
    if(pass.length < 3) {
      show_fail('pass too short');
      return;
    }
    var mail = id('mail');
    if(mail.length > 0 && mail.indexOf('@') < 0) {
      show_fail('mail invalid');
      return;
    }
    var hash = md5(pass + name.toLowerCase());
    var user = push('user|' + name + '|' + mail + '|' + hash);
    if(user[1] == 'done')
      authorize(user[2]);
  }
  function hash() {
    name = id('name');
    if(name.length < 3) {
      show_fail('name too short');
      return;
    }
    var pass = id('pass');
    if(pass.length < 3) {
      show_fail('pass too short');
      return;
    }
    var salt = push('salt|' + name);
    if(salt[1] === 'fail') {
      show_fail(salt[2]);
      return;
    }
    var sign = push('sign|' + salt[2] + '|' + md5(md5(pass + name.toLowerCase()) + salt[2]));
    if(sign[1] == 'done')
      authorize(salt[2]);
  }
  function authorize(salt) {
    display('user', 'none');
    display('room', 'block');
    display('talk', 'block');
    focus('text');
    pull(salt);
  }
  function none(data) {
    push(data);
  }
  function id(name, reset) {
    var value = element(name).value;
    if(reset)
      element(name).value = '';
    return value;
  }
  function display(id, value) {
    element(id).style.display = value;
  }
  function focus(id) {
    element(id).focus();
  }
  function hash_code(e) {
    e = e || window.event;
    var unicode = e.charCode ? e.charCode : e.keyCode ? e.keyCode : 0;
    if(unicode == 13) {
      hash();
    }
  }
  function user_code(e) {
    e = e || window.event;
    var unicode = e.charCode ? e.charCode : e.keyCode ? e.keyCode : 0;
    if(unicode == 13) {
      user();
    }
  }
  function chat_code(e) {
    e = e || window.event;
    var unicode = e.charCode ? e.charCode : e.keyCode ? e.keyCode : 0;
    if(unicode == 13) {
      chat();
    }
  }
  function ally() {
    var select = element('ally');
    var index = select.selectedIndex;
    if(index > -1) {
      var ally = push('ally|' + select.options[index].text);
      if(ally[1] == 'done')
        alert('done');
    }
  }
  function chat() {
    var text = id('text', true)
    send_chat(text);
  }
  function send_chat(text) {
    if(text.length > 0) {
      var select = element('tree');
      var index = select.selectedIndex;
      var tree = select.options[index].text
      none('chat|' + tree + '|' + text);
    }
  }
  function room() {
    push('room|' + make_room());
    clear_join();
  }
  function join() {
    var select = element('join');
    var index = select.selectedIndex;
    if(index == -1) { /* try friend list */
      select = element('ally');
      index = select.selectedIndex;
    }
    if(index > -1) {
      var join = push('join|' + select.options[index].text + '|hejsan');
      if(join[1] == 'done')
        clear_join();
    }
  }
  function quit() {
    var quit = push('quit');
    if(quit[1] == 'done')
      list();
  }
  function list() {
    var list = push('list|room');
    for(var i = 3; i < list.length; i++) {
      add_select('join', list[i].split('+')[0], orange);
    }
  }
  function math_random(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }
  function play() {
    var play = push('play|' + math_random(1, 400000));
    if(play[1] === 'fail')
      show_fail(play[2]);
  }
  function over(data) {
    push('over|' + data);
  }
  function send(data) {
    push('send|' + data);
  }
  function away(event) {
    if(!salt)
      return;
    if(event.type == 'focus')
      push('back');
    if(event.type == 'blur')
      push('away');
  }
</script>
</head>
<body style="margin: 0px;">

<div id="user"><table>
<tr><td colspan="3"><a href="https://github.com/tinspin/fuse"><img border="0" width="140" height="80" src="fuse.svg"></a></td></tr>
<tr><td colspan="3"><div id="fail1"></div></td></tr>
<tr><td>name&nbsp;</td><td><input id="name" name="name" size="10"></td></tr>
<tr><td>pass&nbsp;</td>
    <td><input id="pass" name="pass" type="password" size="10" onkeypress="hash_code(event);"></td>
    <td><a href="javascript:hash();">login</a></td></tr>
<tr><td><font color="[[ green ]]">mail*</font></td>
    <td><input id="mail" name="mail" size="10" onkeypress="user_code(event);"></td>
    <td><a href="javascript:user();">register</a></td></tr>
<tr><td colspan="2"><font color="[[ blue ]]">*optional</font></td></tr>
</table>
<table>
[[	Iterator it = fuse.Router.score.iterator();

	while(it.hasNext()) {
		String score = (String) it.next(); ]]

<tr><td>[[ score ]]</td></tr>

[[	} ]]
</table>
</div>

<div id="room" style="display: none;"><table>
<tr><td colspan="3"><div id="fail2"></div></td></tr>
<tr><td align="center">user</td><td></td>
    <td align="center">room</td></tr>
<tr><td><select id="ally" size="5" multiple></select></td><td></td>
    <td><select id="join" size="5" multiple></select></td></tr>
<tr><td><a href="javascript:ally();">ally</a></td><td></td>
    <td><a href="javascript:room();">room</a>
        <a href="javascript:join();">join</a>
        <a href="javascript:quit();">quit</a>
        <a href="javascript:play();">play</a></td></tr>
</table>
</div>

<div id="play" style="display: none;">

<!-- cube.html contains the game for modularity 
     of you want to use our lobby with your game 
     host a file that mimics play.html and call 
     fuse.rupy.se/play.html?game=<name>&path=URLtoyourgame.html -->
     
[[		if(path.equals("cube.html") || path.equals("bomb.html")) {
			BufferedReader file = new BufferedReader(new FileReader("app/fuse.rupy.se/" + path));
			String line = file.readLine();
			while(line != null) {
				out.println(line);
				line = file.readLine();
			}
		}
		else {
			HttpURLConnection conn = (HttpURLConnection) new URL(path).openConnection();
			conn.setRequestMethod("GET");
			int code = conn.getResponseCode();
			if(code == 200) {
				InputStream in = conn.getInputStream();
				int size = Deploy.pipe(in, event.output());
				in.close();
			}
		} ]]

</div>

<div id="talk" style="display: none;"><table>
<tr><td colspan="3"><textarea id="chat" name="chat" rows="5" readonly></textarea></td></tr>
<tr><td colspan="3">
<select id="tree" style="width: 60px;"><option>root</option><option>stem</option><option>leaf</option></select>
<input id="text" name="text" size="12" onkeypress="chat_code(event);">
<a href="javascript:chat();">chat</a>
</td></tr>
</table>
</div>

<div id="show">
<div id="pull">pull:</div>
<div id="push">push:</div>
</div>

<script>
  focus('name');
  /* disabled for development
  window.onfocus = away;
  window.onblur = away;
  */
</script>

</body>
</html>

[[	}
} ]]