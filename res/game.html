<!DOCTYPE HTML>
<html>
<head>
<style>
  a:link, a:hover, a:active, a:visited { color: #6699ff; }
  img { display: block; }
  div { font-family: monospace; }
  input { font-family: monospace; }
  #fail1 { color: #ff3300; }
  #fail2 { color: #ff3300; }
  textarea {
    font-family: monospace;
    -webkit-box-sizing: border-box;
    -moz-box-sizing: border-box;
    box-sizing: border-box;
    resize: none;
    width: 100%;
  }
  select {
    font-family: monospace;
    -webkit-box-sizing: border-box;
    -moz-box-sizing: border-box;
    box-sizing: border-box;
    width: 100%;
  }
  #show {
    position: fixed;
    bottom: 5px;
    left: 5px;
  }
</style>
<script src="md5.js"></script>
<script src="swipe.js"></script>
<!-- fuse network code -->
<script>
  var host = window.location.search.substring(1);
  if(!host)
    host = 'fuse.rupy.se';
  var game = 'kloss';
  var show = true;
  var name = '';
  var size = 0;
  var salt;
  function pull() {
    send('pull', name, null);
  }
  function push(data) {
    var data = send('push', name, data).split('|');
    if(data[1] == 'fail')
      show_fail(data[2]);
    return data;
  }
  function send(path, name, data) {
    hide_fail();
    var state = (path == 'pull' ? 3 : 4);
    var xhr = new XMLHttpRequest();
    var ie = false;
    if(state == 3)
      try { xhr = new XDomainRequest(); ie = true; } catch(e) {}
    if(salt) data = data.substring(0, 4) + '|' + salt + data.substring(4, data.length);
    var url = 'http://' + host + '/' + path + '?name=' + name + '&data=' + encodeURIComponent(data) + (ie ? "&ie" : "") + "&time=" + new Date().getTime();
    xhr.open('GET', url, state == 3); // sync is deprecated really? genious!
    try { xhr.setRequestHeader('Accept', 'text/event-stream'); } catch(e) {}
    if(state == 3) {
      if(ie)
        xhr.onprogress = function() {
          var body = xhr.responseText.substring(size, xhr.responseText.length);
          chop(body, '\n'); // last \n instead
          size = xhr.responseText.length;
        };
      else
        xhr.onreadystatechange = function() {
          if(xhr.readyState == 3) {
            var body = xhr.responseText.substring(size, xhr.responseText.length);
            chop(body, '\n\n'); // last \n\n instead
            size = xhr.responseText.length;
          }
        };
    }
    xhr.send();
    if(state == 4) {
      if(show)
        element('push').innerHTML += xhr.responseText + '\n';
      return xhr.responseText;
    }
  }
  function chop(body, delimiter) {
    var part = body.split(delimiter);
    for(var i = 0; i < part.length; i++) {
      var trim = part[i].trim();
      if(trim.length > 0)
        if(trim.indexOf('data: ') == 0)
          read(trim.substring(6, trim.length));
        else
          read(trim);
    }
  }
  function element(name) {
    return document.getElementById(name);
  }
</script>
<!-- fuse message handling -->
<script>
  var send_game = true;
  function read(data) {
    //try { console.log(data) } catch(e) {}
    if(show)
      element('pull').innerHTML += data + '\n';
    if(send_game) {
      setTimeout(function() { push('game|' + game); list() }, 1000); // Give IE time to handle 2000kb payload.
      send_game = false;
    }
    var split = data.split('|');
    if(split.length > 1 && split[0] == 'text') {
      element('chat').value = split[1] + ': ' + split[2] + '\n' + element('chat').value;
    }
    if(split.length > 0) {
      if(split[0] == 'here') {
        var select = element('ally');
        for(var i = 0; i < select.options.length; i++) {
          if(select.options[i].text == split[1]) {
            return;
          }
        }
        var option = document.createElement('option');
        option.text = split[1];
        select.options.add(option, select.options[0]);
      }
      if(split[0] == 'gone') {
        var select = element('ally');
        var id = 0;
        for(var i = 0; i < select.options.length; i++) {
          if(select.options[i].text == split[1]) {
            id = i;
            break;
          }
        }
        select.remove(id);
      }
      if(split[0] == 'made') {
        add_room(split[1]);
      }
      if(split[0] == 'halt') {
        var select = element('join');
        var id = 0;
        for(var i = 0; i < select.options.length; i++) {
          if(select.options[i].text == split[1]) {
            id = i;
            break;
          }
        }
        select.remove(id);
      }
    }
  }
  function add_room(room) {
    var name = room.split('+')[0];
    var select = element('join');
    for(var i = 0; i < select.options.length; i++) {
      if(select.options[i].text == name) {
        return;
      }
    }
    var option = document.createElement('option');
    option.text = name;
    select.options.add(option, select.options[0]);
  }
  function clear() {
    var select = element('join');
    var length = select.options.length;
    for(i = 0; i < length; i++) {
      select.options[i] = null;
    }
  }
  function hide_fail(text) {
    element('fail1').innerHTML = '';
    element('fail2').innerHTML = '';
  }
  function show_fail(text) {
    element('fail1').innerHTML = text;
    element('fail2').innerHTML = text;
  }
</script>
<!-- fuse view handling -->
<script>
  function user() {
    name = id('name');
    if(name.length < 3) {
      show_fail('name too short');
      return;
    }
    var pass = id('pass');
    if(pass.length < 3) {
      show_fail('pass too short');
      return;
    }
    var mail = id('mail');
    if(mail.length > 0 && mail.indexOf('@') < 0) {
      show_fail('mail invalid');
      return;
    }
    var hash = md5(pass + name);
    var user = push('user|' + mail + '|' + hash);
    if(user[1] == 'done')
      authorize(user[4]);
  }
  function open() {
    name = id('name');
    if(name.length < 3) {
      show_fail('name too short');
      return;
    }
    var pass = id('pass');
    if(pass.length < 3) {
      show_fail('pass too short');
      return;
    }
    var salt = push('salt');
    if(salt[1] === 'fail') {
      show_fail('failed salt');
      return;
    }
    var hash = md5(md5(pass + name) + salt[2]);
    var open = push('open|' + salt[2] + '|' + hash);
    if(open[1] == 'done')
      authorize(salt[2]);
  }
  function authorize(salt) {
    display('user', 'none');
    display('room', 'block');
    display('talk', 'block');
    pull();
    focus('text');
    this.salt = salt;
  }
  function none(data) {
    send('push', name, data);
  }
  function id(name, reset) {
    var value = element(name).value;
    if(reset)
      element(name).value = '';
    return value;
  }
  function display(id, value) {
    element(id).style.display = value;
  }
  function focus(id) {
    element(id).focus();
  }
  function open_code(e) {
    e = e || window.event;
    var unicode = e.charCode ? e.charCode : e.keyCode ? e.keyCode : 0;
    if(unicode == 13) {
      open();
    }
  }
  function chat_code(e) {
    e = e || window.event;
    var unicode = e.charCode ? e.charCode : e.keyCode ? e.keyCode : 0;
    if(unicode == 13) {
      chat();
    }
  }
  function ally() {
    var select = element('ally');
    var index = select.selectedIndex;
    if(index > -1) {
      var ally = push('ally|' + select.options[index].text);
      if(ally[1] == 'done')
        alert('ally');
    }
  }
  function chat() {
    var text = id('text', true)
    if(text.length > 0)
      none('chat|' + text);
  }
  function room() {
    push('room|kloss|2');
    clear();
  }
  function join() {
    var select = element('join');
    var index = select.selectedIndex;
    if(index > -1) {
      var join = push('join|' + select.options[index].text);
      if(join[1] == 'done')
        clear();
    }
  }
  function quit() {
    var quit = push('quit');
    if(quit[1] == 'done')
      list();
  }
  function list() {
    var list = push('list|room');
    for(var i = 3; i < list.length; i++) {
      add_room(list[i]);
    }
  }
  function play() {
    var play = push('play');
    if(play[1] == 'done') {
      display('room', 'none');
      display('play', 'block');
      element('talk').style.position = 'absolute';
      element('talk').style.left = '0px';
      element('talk').style.top = '300px';
      for(var i = 0; i < 5; i++) {
        cubes.push({'name': names[i], 'x': 0, 'y': 0});
      }
      setInterval(tick, 1000 / 60);
    }
  }
  var cubes = [];
  var names = ['blue', 'green', 'orange', 'purple', 'red'];
  function tick() {
    for(var i = 0; i < cubes.length; i++) {
      var cube = element(cubes[i].name);
      cubes[i].y += 1;
      cube.style.top = cubes[i].y + 'px';
      if(cubes[i].y > 250)
        cubes[i].y = 0;
    }
  }
</script>
</head>
<body>

<div id="user"><table>
<tr><td colspan="3"><div id="fail1"></div></td></tr>
<tr><td>name&nbsp;&nbsp;</td><td><input id="name" size="10"></td></tr>
<tr><td>pass&nbsp;&nbsp;</td>
    <td><input id="pass" type="password" size="10" onkeypress="open_code(event);"></td>
    <td><a href="javascript:open();">login</a></td></tr>
<tr><td><font color="#00cc33">mail*</font>&nbsp;</td>
    <td><input id="mail" size="10"></td>
    <td><a href="javascript:user();">register</a></td></tr>
<tr><td colspan="2"><font color="#ff9900">*optional</font></td></tr>
</table>
</div>

<div id="room" style="display: none;"><table>
<tr><td colspan="3"><div id="fail2"></div></td></tr>
<tr><td align="center">user</td><td></td>
    <td align="center">room</td></tr>
<tr><td><select id="ally" size="5" multiple></select></td><td></td>
    <td><select id="join" size="5" multiple></select></td></tr>
<tr><td><a href="javascript:ally();">ally</a></td><td></td>
    <td><a href="javascript:room();">room</a>
        <a href="javascript:join();">join</a>
        <a href="javascript:quit();">quit</a>
        <a href="javascript:play();">play</a></td></tr>
</table>
</div>

<div id="play" style="display: none;" ontouchstart="touchStart(event,'box');" ontouchend="touchEnd(event);" ontouchmove="touchMove(event);" ontouchcancel="touchCancel(event);">
<img id="blue" style="position: absolute; left: 0px;" src="svg/blue.svg">
<img id="green" style="position: absolute; left: 50px;" src="svg/green.svg">
<img id="orange" style="position: absolute; left: 100px;" src="svg/orange.svg">
<img id="purple" style="position: absolute; left: 150px;" src="svg/purple.svg">
<img id="red" style="position: absolute; left: 200px;" src="svg/red.svg">
</div>

<div id="talk" style="display: none;"><table>
<tr><td colspan="3"><textarea id="chat" rows="5" readonly></textarea></td></tr>
<tr><td colspan="3">
<input id="text" size="25" onkeypress="chat_code(event);">
<a href="javascript:chat();">chat</a>
</td></tr>
</table>
</div>

<div id="show">
<div id="pull">pull:</div>
<div id="push">push:</div>
</div>

<script>
  focus('name');
</script>

</body>
</html>